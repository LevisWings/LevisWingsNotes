# Enumeration

## Detect version SMB

[Here](theory-smb.md#versions) is a list of SMB versions.

### With tools

With the following tools we can see the SMB version: CrackMapExec, smbclient, smbmap and enum4linux.

The command to use can be to simply list the shared resources, as shown here.

### With ngrep and smbclient

```bash
# Terminal 1:
ngrep -i -d tap0 's.?a.?m.?b.?a.*[[:digit:]]' port 139
# Terminal 2:
echo exit | smbclient -L <IP>
```

### With smbver.sh

```bash
#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
sleep 0.5 && echo ""
```

### With WireShark

Sometimes nmap does not show the **version of Samba** on the remote host, if this happens, a good way to know what version the remote host is running, is to capture the traffic with **Wireshark** against the remote host on 445/139 and in parallel run a `smbclient -L`, do a **follow tcp stream** and with this we could see what version the server is running.

## Check vulns

```bash
# Scan for possible SMB vulnerabilities:
sudo nmap --script='smb-vuln*' -p 139,445 <IP> 
```

## Possible credentials

|                      |                                         |
| -------------------- | --------------------------------------- |
| (blank)              | (blank)                                 |
| Guest                | (blank)                                 |
| Administrator, admin | (blank), password, administrator, admin |
| arcserve             | arcserve, backup                        |
| tivoli, tmersrvd     | tivoli, tmersrvd, admin                 |
| backupexec, backup   | backupexec, backup, arcada              |
| test, lab, demo      | password, test, lab, demo               |

## List of permissions

Keep in mind that NTFS permissions apply to the system where the folder and files are hosted. Folders created in NTFS inherit permissions from parent folders by default. It is possible to disable inheritance to set custom permissions on parent and subfolders, as we will do later in this module. The share permissions apply when the folder is being accessed through SMB, typically from a different system over the network. This means someone logged in locally to the machine or via RDP can access the shared folder and files by simply navigating to the location on the file system and only need to consider NTFS permissions. The permissions at the NTFS level provide administrators much more granular control over what users can do within a folder or file.

### Methods

{% hint style="info" %}
**Read permissions** (recommended in case something appears in hexadecimal format): [https://lists.samba.org/archive/samba-technical/2010-June/071390.html](https://lists.samba.org/archive/samba-technical/2010-June/071390.html). For example, the flag or mask `0x00100116` means that we have write permissions.
{% endhint %}

{% tabs %}
{% tab title="smbcacls" %}
```bash
smbcacls //<IP>/<SHAREDFOLDER> <DIRECTORY> -N # No credentials.
smbcacls //<IP>/<SHAREDFOLDER> <DIRECTORY> -U "<USERNAME>%<PASSWORD>" # With credentials.
smbcacls //<IP>/<SHAREDFOLDER> <DIRECTORY> -U "<USERNAME>%<PASSWORD>" | grep -i -E "<GROUP/USERNAME>" # Ex: EVERYONE
smbcacls //<IP>/<SHAREDFOLDER> <DIRECTORY>/<SUBDIRECTORY> -N # No credentials, in a subdirectory
```
{% endtab %}

{% tab title="smbcacls + Bash" %}
{% hint style="warning" %}
For this case we need the **mounted share**. If this is not possible, you can write down the directories in a **directories.txt** file and do a for as follows: `for file in $(cat directories.txt) ...`
{% endhint %}

```bash
# We are located in the previously mounted shared resource:
cd /mnt/smbmounted
# For directories:
for file in $(ls); do echo $file; done  | while read line; do echo -e "\n [*] $line:\n"; smbcacls //<IP>/<SHAREDFOLDER> $line -N; done
for file in $(ls); do echo $file; done  | while read line; do echo -e "\n [*] $line:\n"; smbcacls //<IP>/<SHAREDFOLDER> $line -N | grep -i "<GROUP/USERNAME>"; done
# For the subdirectories of a directory:
for file in $(ls); do echo $file; done  | while read line; do echo -e "\n [*] $line:\n"; smbcacls //<IP>/<SHAREDFOLDER> <DIRECTORY>/$line -N; done
```
{% endtab %}

{% tab title="Bash" %}
{% hint style="danger" %}
May give false positives.
{% endhint %}

```bash
#!/bin/bash

find . -type d | while read directory; do 
touch ${directory}/leviswings 2>/dev/null && echo "${directory} - File created" && rm ${directory}/leviswings
mkdir ${directory}/leviswings 2>/dev/null && echo "${directory} - Directory created" && rmdir ${directory}/leviswings
done
```
{% endtab %}
{% endtabs %}

## Checking file blacklist

For this, we need write permissions on at least one SMB directory. If we have it, we can create several files and see which ones are deleted:

```bash
cd <DIRECTORY>
touch ./leviswings.{exe,dll,scf}
```
