# Techniques

## List shared folders

{% hint style="warning" %}
It may be that from Windows Server 2016 and Windows 10, it is necessary to indicate that the minimum SMB protocol is **SMB2**. This can be configured in the file `/etc/samba/smb.conf` and then restart the service with: `sudo /etc/init.d/smbd restart`
{% endhint %}

It is always advisable to see if you can access something, if you don't have credentials try using **null credentials**/**guest user**.

{% tabs %}
{% tab title="CrackMapExec" %}
```bash
crackmapexec smb <IP> --shares
crackmapexec smb <IP> -u '<USERNAME>' -p '<PASSWORD>' --shares
crackmapexec smb <IP> -u Guest -p '' --shares # Guest account
crackmapexec smb <IP> -u '<USERNAME>' -p '<PASSWORD>' -M spider_plus # Enumerate directories recursively
```
{% endtab %}

{% tab title="smbclient" %}
```bash
smbclient -L <IP>
smbclient -L <IP> -N # No password.
smbclient -L <IP> -U 'Guest%' # Guest account.
smbclient -L <IP> -U <USERNAME>%<PASSWORD> # With credentials.
smbclient -L <IP> -U "<DOMAIN>\<USERNAME>" # At the domain level, then enter the password.
```
{% endtab %}

{% tab title="smbmap" %}
```bash
smbmap -H <IP> # If it says "Acess denied" or nothing comes up, try other commands.
smbmap -H <IP> -u 'null' # Guest Session. 
smbmap -H <IP> -u 'Guest' -p '' # Same as above.
smbmap -H <IP> -u '' -p '' # Null credentials.
smbmap -u <USERNAME> -p <PASSWORD> -d <DOMAIN> -H <IP>

smbmap [-u "username" -p "password"] -R [Folder] -H <IP> [-P <PORT>] # Recursive list
smbmap [-u "username" -p "password"] -r [Folder] -H <IP> [-P <PORT>] # Non-Recursive list
smbmap -u "username" -p "<NT>:<LM>" [-r/-R] [Folder] -H <IP> [-P <PORT>] #Pass-the-Hash
```
{% endtab %}

{% tab title="nmap" %}
```bash
nmap --script smb-enum-shares -p 139,445 <IP>
```
{% endtab %}
{% endtabs %}

## Connect SMB share

{% tabs %}
{% tab title="smbclient" %}
```bash
smbclient //<IP>/<SHARED FOLDER> -N # No password.
smbclient //<IP>/<SHARED FOLDER> -U '<USERNAME>%<PASSWORD>'
```
{% endtab %}

{% tab title="GUI (Linux)" %}
### In the terminal

```bash
xdg-open smb://<IP>/
```

### In file browser window (nautilus, thunar, etc.)

```
smb://<IP-DOMAIN>/<SHARED_FOLDER>/
```
{% endtab %}
{% endtabs %}

## SMB commands

These commands can be executed when we are in an SMB session (SMB shell), that is, connected to a shared resource:

### General commands

```bash
get "<FILENAME>" # Download the file to our current directory.
allinfo <FILE> # View file information.
get <FILE>:<STREAM> # This is to download a file by specifying the stream.
logon "<USERNAME>" # Start as another user inside the SMB shell.
```

### Download all

```bash
recurse ON # To download everything recursively.
prompt OFF # So that it does not ask us whether to download or not.
mget * # To download everything.
```

<details>

<summary>Explanation of the commands to download everything:</summary>

* `prompt` : Toggle the file name request during the operation of the `mget` and `mput` commands. When enabled (**ON**), the user must confirm the transfer of each file during these commands. When disabled (**OFF**), all specified files will be transferred without prompting.

<!---->

* `recurse` : Toggle directory recursion for the `mget` and `mput` commands. When enabled (**ON**), these commands will process all directories in the source directory (i.e., the directory they are copying from) and recurse any that match the mask specified for the command. Only files that match the mask specified with the mask command will be retrieved. When recursion is disabled (**OFF**), only files in the current working directory on the source machine that match the mask specified with the `mget` or `mput` commands will be copied, and any mask specified with the mask command will be ignored.
* `mget *` : Download all files.

</details>

## Overall Scan

{% tabs %}
{% tab title="enum4linux" %}
```bash
enum4linux <IP>
enum4linux -a [-u "<USERNAME>" -p "<PASSWORD>"] <IP>
enum4linux -A <IP>
enum4linux-ng -A [-u "<USERNAME>" -p "<PASSWORD>"] <IP>
```
{% endtab %}

{% tab title="nmap" %}
```bash
# Execute all SMB scripts:
sudo nmap --script='smb-*' -p 139,445 <IP>
```
{% endtab %}
{% endtabs %}

## Download files

{% tabs %}
{% tab title="smbmap" %}
```bash
smbmap -u <USERNAME> -p <PASSWORD> -d <DOMAIN> -H <IP> -R <SHARED FOLDER> -A <BuscarArchivo> -q # Search for the file and download it if found.
smbmap -H <IP> --download <SHARED FOLDER>/<PATH>/<FILENAME> # To download a file from a shared folder.
```
{% endtab %}

{% tab title="smbget" %}
```bash
# With valid credentials:
smbget -R smb://<IP>/<SHARED FOLDER> -U '<USERNAME>'
# This is in case one file cannot be downloaded, let it continue with the others:
smbget -rR smb://<IP>/<SHARED FOLDER> -U '<USERNAME>'
```
{% endtab %}
{% endtabs %}

## SMB Mount

Mount an SMB resource on our computer for convenience. It should be clarified that valid credentials are required.

```bash
cd /mnt/smbmounted # If it does not exist, create it.
# Ways to mount an SMB share:
mount -t cifs //<IP>/<ShareFolder> /mnt/smbmounted # Way 1, it will ask for credentials, but if we don't have them we simply press Enter.
mount -t cifs //<IP>/<ShareFolder> /mnt/smbmounted -o username=<USERNAME>,password=<PASSWORD> # Way 2
mount -t cifs //<IP>/<ShareFolder> /mnt/smbmounted -o username=<USERNAME>,password=<PASSWORD>,rw # Way 3
mount -t cifs //<IP>/<ShareFolder> /mnt/smbmounted -o username=<USERNAME>,password=<PASSWORD>,domain=<DOMAIN>,rw # Way 4
# In addition to the "rw" parameters, we can also specify other things: user=root,uid=0,gid=0,vers=1.0
# Example:
mount -t cifs //10.10.10.40/Users /mnt/smbmounted -o username=Guest,password=,domain=WORKGROUP,rw
mount -t cifs //10.10.10.40/Users /mnt/smbmounted -o username="levi",password='123',domain=levi.local,rw
# Dismount the shared resource:
umount /mnt/smbmounted
```

### Troubleshooting

#### Problem #1. I cannot write to a directory where I have write permissions

```bash
# Instead of doing the following...:
sudo touch /smb/smbmounted/WriteFolder/test.txt
# ... fool the system by moving the file to that location:
touch test.txt
sudo mv test.txt /mnt/smbmounted/WriteFolder/test.txt
```

#### Problem #2. Error message in mount:

If we get the following error when trying to mount:

![](../../.gitbook/assets/mount\_error.png)

Then we modify the code with the following:

```bash
mount -t cifs //<IP>/<SHARED_FOLDER> /mnt/smbmounted -o vers=2.1
```

That's it. The only thing we did was to change the version.
