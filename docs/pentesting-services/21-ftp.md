# 21 - FTP

## Theory

File Transfer Protocol (FTP) is a standard network protocol used for transferring computer files between a client and a server on a computer network.

### Connections

FTP protocol usually uses two connections – one control connection and one data connection. Commands are transferred using control connection and data travels through the data connection.

In Active FTP, the FTP client first initiates the control connection from its port N to FTP Server's command port – port 21. The client then listens to port N+1 and sends the port N+1 to FTP Server. FTP Server then initiates the data connection, from its port M to the port N+1 of the FTP Client.

But, if the FTP Client has a firewall set up that controls the incoming data connections from outside, then active FTP may be a problem. And, a feasible solution for that is Passive FTP.

In Passive FTP, the client initiates the control connection from its port N to the port 21 of the FTP Server. After this, the client issues a `passv` comand. The server then sends the client one of its port number M. And the client initiates the data connection from its port P to port M of the FTP Server.

{% embed url="https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack" %}

## Practice

### Authentication

{% tabs %}
{% tab title="Linux" %}
```bash
ftp <IP> <PORT>
nc -nv <IP> 21
ncftp <IP>
lftp <IP>
curl 'ftp://<USER>:<PASSWORD>@<IP>:<PORT>/'
curl -s -v -P - 'ftp://<USERNAME>:<PASSWORD>@<IP>/'
telnet <IP> <PORT>
```
{% endtab %}

{% tab title="Python" %}

{% endtab %}
{% endtabs %}

### Banner grabbing

```bash
nc -vn <IP> 21
openssl s_client -connect <IP>:21 -starttls ftp # Get certificate if any
```

### Commands

```bash
# Basics:
pwd # Print current directory
put <FILENAME> # Upload a file to the current directory.
get <FILENAME> # Download file.
delete <FILENAME> # Delete file.
bye # Quit.
binary # Set the file transfer mode to binary. This is recommended to avoid errors when downloading or transferring files. By default we are in ASCII.
chmod 777 <FILE> # Assign maximum permissions to a file. MAY BE NECESSARY WHEN UPLOADING A FILE TO RUN IT.
append # Upload a file (it will ask for the name/path of the local file and then the new name of the remote file, i.e. on the server)
# Switch to passive mode (recommended if we can't do basic functions like ls):
passive
pass
pasv
```

### Permissions

Remember to look at the permissions of all directories/files on an FTP server. If some have write permissions, we can upload or replace files.

* In the case of uploading files, it is useful if there is a user who uses a binary/script frequently or if that directory can be viewed over HTTP (in this case, we would upload a reverse shell with the programming language that the server is using).
* In the case of replacing files, we can suspect a script that is running every so often. In that case, we simply replace that script with our own script.

### Upload/Download

{% content-ref url="../general/file-transfer/general-file-transfer/ftp-transfer-files.md" %}
[ftp-transfer-files.md](../general/file-transfer/general-file-transfer/ftp-transfer-files.md)
{% endcontent-ref %}

### Fake FTP server

Simulate an FTP server with different tools, which can be ideal if we are receiving traffic on port 21.

{% tabs %}
{% tab title="nc" %}
```bash
nc -nvlp 21
<Enter> # We press the Enter key when we receive a connection.
331 Please, enter your password: # We write this for the user to enter his password (https://en.wikipedia.org/wiki/List_of_FTP_server_return_codes)
# Done, it will give us your password in clear text.
```
{% endtab %}
{% endtabs %}

### FTP config files

* `ftpusers`
* `ftp.conf`
* `proftd.conf`

### FTP checklist

* [ ] **Identify the FTP version**. Is it vulnerable?

If you have credentials, authenticate. If you do not have them:

* [ ] Do you allow **authentication** with the **user anonymous**?
* [ ] Do you have a user? **Try brute force**. This method should be used as a **last resort** if you can't find anything in other services.

If we have an FTP session:

* [ ] Can't **list files**? Remember to use passive mode.
* [ ] What directory are we in?
* [ ] Can we **download** files?
  * [ ] If there are any interesting files, download them.
* [ ] **Check the permissions** of all files and directories.
* [ ] Can we **upload** or **overwrite** files?
  * [ ] Do you suspect that a user or task is interacting with the FTP service? If so, we can overwrite a script or upload an exploit that abuses a task running on that service.
  * [ ] Are there configuration files? Download them and see if they may be synchronized with other services (for example, if there is an http configuration file that denies access to a user, we can overwrite the file to allow access).
  * [ ] Is the FTP server synchronized to another service (such as HTTP)? Try uploading a webshell with the programming language being used in the backend.

{% file src="../.gitbook/assets/ftp_checklist_notes.md" %}
