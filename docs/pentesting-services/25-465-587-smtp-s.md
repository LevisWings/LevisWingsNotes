# 25,465,587 - SMTP/s

## Theory

SMTP (**Simple Mail Transfer Protocol**) is a TCP/IP protocol used to **send and receive e-mail**. However, because its ability to queue messages at the receiving end is limited, it is often used with one of the other two protocols, POP3 or IMAP, which allow the user to store messages in a mailbox on the server and periodically download them from the server.

In other words, users typically use a program that uses SMTP to send e-mail and POP3 or IMAP to receive e-mail. On Unix-based systems, sendmail is the most commonly used SMTP server for e-mail. A commercial package, Sendmail, includes a POP3 server. Microsoft Exchange includes an SMTP server and can also be configured to include POP3 support. From [here](https://whatis.techtarget.com/definition/SMTP-Simple-Mail-Transfer-Protocol).

## Enumeration

### Basic actions

```bash
# Banner grabbing (SMTP):
nc -vn <IP> 25
telnet <IP>:25
telnet <IP> 25
# Banner grabbing (SMTPS):
openssl s_client -crlf -connect smtp.mailgun.org:465 # SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
# Finding MX servers of an organisation:
dig +short mx google.com
# Enumeration with nmap:
nmap --script 'smtp-*' -p 25 <IP>
```

### Send email

{% tabs %}
{% tab title="sendmail" %}
```bash
sendmail -f "<EMAIL>" -t "<RECEPTOR_EMAIL>" -u "<SUBJECT>" -m "<MESSAGE>" -s <SERVER> -a <FILE> -v
```
{% endtab %}

{% tab title="swaks" %}
For these commands, you need a file with all emails (for each line):

```bash
# One liner:
swaks --from <RANDOM_MAIL> --to $(cat emails.txt | tr '\n' ',') --header "Subject: test" --body "<CONTENT>" --server <IP>
swaks --from <RANDOM_MAIL> --to $(cat emails.txt | tr '\n' ',') --header "Subject: test" --body "<CONTENT>" --attach <FILE> --server <IP>
# Bash script:
for email in $(cat email.txt); do
    swaks --from <RANDOM_MAIL> --to $email --header "Subject: test" --body "<CONTENT>" --server <IP>
done
```
{% endtab %}
{% endtabs %}

### SMTP Client

```python
import smtplib

smtp_server = "smp.gmail.com"
port = 25
sender_email = 'your_email@gmail.com'
receiver_email = 'receiver_email@gmail.com'

message = "AAA"

try:
    server = smtplib.SMTP(smtp_server, port)
    server.ehlo() # Can be omitted.
    server.sendmail(sender_email, receiver_email, message)
    print ("Email sent successfully!")
except Exception as ex:
    print ("Something went wrongâ€¦.",ex)
finally:
    server.quit()

```

### SMTP Server

```bash
# Oneliner:
sudo python3 -m smtpd -n -c DebuggingServer <LHOST>:25
```

### NTLM Auth - Information disclosure

If the server supports NTLM auth (Windows) you can obtain sensitive info (versions). More info [here](https://medium.com/@m8r0wn/internal-information-disclosure-using-hidden-ntlm-authentication-18de17675666).

```bash
root@kali: telnet example.com 587
220 example.com SMTP Server Banner
>> HELO
250 example.com Hello [x.x.x.x]
>> AUTH NTLM 334
NTLM supported
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
334 TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```

Or automate this with nmap plugin [smtp-ntlm-info.nse](https://nmap.org/nsedoc/scripts/smtp-ntlm-info.html).

### Sniffing

Check if you sniff some password from the packets to port 25.

### Auth Bruteforce

```bash
hydra -l <username> -P /path/to/passwords.txt <IP> smtp -V
hydra -l <username> -P /path/to/passwords.txt -s 587 <IP> -S -v -V #Port 587 for SMTP with SSL
```

### Principal commands

{% embed url="https://serversmtp.com/smtp-commands" %}

### User enumeration

If an SMTP server is misconfigured, some commands may be available:

* **VRFY** - ask the server to verify an email address.
* **EXPN** - ask the server for mailing list membership.
* **RCPT TO** - specifies the full path address of the mail recipient.

> MSF description: The **SMTP** service has two internal commands that allow user enumeration: VRFY (which confirms valid user names) and EXPN (which reveals the real address of alias users and mailing lists (mailing lists)). By implementing these SMTP commands a list of valid users can be revealed.

{% tabs %}
{% tab title="Manual" %}
```bash
# RCPT TO
> nc <IP> 25
> HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
> MAIL FROM:test@test.org
250 2.1.0 test@test.org... Sender ok
> RCPT TO:test
550 5.1.1 test... User unknown
> RCPT TO:admin
550 5.1.1 admin... User unknown
> RCPT TO:ed
250 2.1.5 ed... Recipient ok

# VRFY
> telnet 10.0.0.1 25
> HELO
501 HELO requires domain address
> HELO x
250 myhost Hello [10.0.0.99], pleased to meet you
> VRFY root              <-- Verificar si existe un usuario
250 Super-User <root@myhost>
> VRFY blah              <-- Este usuario no existe
550 blah... User unknown

# EXPN
> nc <IP> 25
Trying 10.0.10.1...
Connected to 10.0.10.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
> HELO
501 HELO requires domain address
> HELO x
> EXPN test
550 5.1.1 test... User unknown
> EXPN root
250 2.1.5 <ed.williams@myhost>
> EXPN sshd
250 2.1.5 sshd privsep <sshd@mail2>
```
{% endtab %}

{% tab title="smtp-user-enum.pl" %}
**smtp-user-enum** is a tool for enumerating user accounts at the operating system level on Solaris through the SMTP (sendmail) service. Enumeration is performed by inspecting responses to VRFY, EXPN and RCPT TO commands. It could be adapted to work against other vulnerable SMTP daemons, but this has not been done as of v1.0.

{% hint style="warning" %}
A **list of users** is needed, then we can enumerate if they are valid using the **VRFY**, **EXPN** or **RCPT TO** command.
{% endhint %}

```bash
smtp-user-enum -M <MODE> -U <WORDLIST> -t <IP> # Syntax
smtp-user-enum.pl -M VRFY -U users.txt -t <IP>
smtp-user-enum.pl -M EXPN -U users.txt -t <IP>
smtp-user-enum -M RCPT -U test-users.txt -t <IP>
# List valid e-mail addresses for a domain (e.g. example.com):
smtp-user-enum.pl -D example.com -M RCPT -U users.txt -t <IP>
```
{% endtab %}

{% tab title="nmap" %}
```bash
nmap --script smtp-enum-users <IP>
```
{% endtab %}

{% tab title="ismtp" %}
```bash
# iSMTP:
# Find valid e-mail accounts:
ismtp -h $IP:25 -e emails.txtde
```
{% endtab %}

{% tab title="Metasploit" %}
```bash
auxiliary/scanner/smtp/smtp_enum
```
{% endtab %}
{% endtabs %}

### Linux location emails

```bash
/var/mail # Dir
/var/mail/<USERNAME> # File
/var/spool/mail # Dir
/var/spool/mail/<USERNAME> # File
```

## Other techniques

INSERT LINK TO LFI VIA EMAIL
