# Race Condition

## Theory

A race condition is an undesirable situation that occurs when a device or system attempts to perform two or more operations at the same time, but because of the nature of the device or system, the operations must be done in the proper sequence to be done correctly.

Let's leave some examples to better understand this concept:

> **Real World Example**: A simple example of a race condition is a light switch. In some homes there are multiple light switches connected to a common ceiling light. When these types of circuits are used, the switch position becomes irrelevant. If the light is on, moving either switch from its current position turns the light off. Similarly, if the light is off, then moving either switch from its current position turns the light on. With that in mind, imagine what might happen if two people tried to turn on the light using two different switches at exactly the same time. One instruction might cancel the other or the two actions might trip the circuit breaker.

> **Computer Science example:** Race conditions are most commonly associated with computer science. In computer memory or storage, a race condition may occur if commands to read and write a large amount of data are received at almost the same instant, and the machine attempts to overwrite some or all of the old data while that old data is still being read. The result may be one or more of the following: a computer crash, an “illegal operation,” notification and shutdown of the program, errors reading the old data or errors writing the new data. A race condition can also occur if instructions are processed in the incorrect order.

So, from a security point of view, a race condition occurs when two or more threads can access shared data and they try to change it at the same time. Because the thread scheduling algorithm can swap between threads at any time, you don’t know the order in which the threads will attempt to access the shared data. Therefore, the result of the change in data is dependent on the thread scheduling algorithm, i.e. both threads are “racing” to access/change the data.

### Using a single-use code multiple times:

If you notice that the web page performs some action that should be done only once, try to get the action to be performed several times and see if there is a different result. If that is the case, there is a race condition vulnerability. Most of the time this is directly related to money. For example, if you need to transfer money from one account to another, you can try to do it multiple times **at the same time or simultaneously**. Also if you can add something of value (such as money, points, etc.) to your own account, you can test for such a vulnerability.

If there is a package, library, plugin or something similar that supports asynchronous/async web requests, we can test if it is vulnerable to the race condition.

Example of a transfer to the user "leviswings":

```bash
#!/bin/bash
# Actual money: 1
# Loop with a curl request, asynchronously using &.
# sleep .1 to give the server some breathing room.

for i in {1..100}; do sleep .1; curl -s -k -X POST \
    -H 'Content-Type: application/x-www-form-urlencoded' \
    -H 'Cookie: RANDOM_COOKIE' \
    -d 'username=leviswings&amount=1&confirm=yes' \
    'https://127.0.0.1/api/send_dollars' & done
```

Example in a bug bounty program:

{% embed url="https://pravinponnusamy.medium.com/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43" %}

### Other cases

{% embed url="https://rafalharazinski.gitbook.io/security/other-web-vulnerabilities/local-remote-file-inclusion/phpinfo-log-race-condition" %}
