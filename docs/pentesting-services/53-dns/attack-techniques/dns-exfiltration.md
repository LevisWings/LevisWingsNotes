# DNS Exfiltration

### Theory

The DNS protocol can be an excellent ally as an [exfiltration mechanism](https://blogs.akamai.com/2017/09/introduction-to-dns-data-exfiltration.html). There are certain situations where a server is in an isolated network and does not have access to the Internet, but is allowed to perform DNS queries in order to function properly. If the local DNS server is misconfigured and makes recursive DNS requests to other DNS servers on the Internet, this can be abused to bypass the firewall rules and send data to the outside.

```bash
														local recursive           fake.com authoritative
    client                     DNS server                   DNS server
    .---.                        .---.                        .---.         
   /   /|  websvr01.fake.com?   /   /|  websvr01.fake.com?   /   /|
  .---. | --------local------> .---. | ------internet-----> .---. |
  |   | '                      |   | '                      |   | '
  |   |/    40.113.200.201     |   |/    40.113.200.201     |   |/
  '---'   <------------------- '---'   <------------------- '---'
```

For example, if we have a DNS server for the domain `fake.com`, all DNS queries for `fake.com` and its subdomains will reach our server. For example, if we want to exfiltrate the name of the isolated server, we can use it as a subdomain and query `websvr01.fake.com`. This query should pass through the local DNS server and reach our DNS server on the Internet. To take advantage of this type of technique we can use a tool such as [iodine](https://github.com/yarrick/iodine) or [dnscat2](https://github.com/iagox86/dnscat2).

### References

{% embed url="https://youtu.be/49F0co_VrTY" %}
